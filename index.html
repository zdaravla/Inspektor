<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Inspektor v5_6</title>
<style>
:root {
  --bg:#111; --s1:#1c1c1e; --s2:#2c2c2e; --s3:#3a3a3c;
  --acc:#f5a623; --txt:#f2f2f7; --txt2:#8e8e93;
  --danger:#ff3b30; --green:#34c759; --r:12px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:-apple-system,'Helvetica Neue',sans-serif;overflow:hidden}

/* SCREENS */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--bg);transition:transform .28s ease;overflow:hidden}
.screen.off-right{transform:translateX(100%)}
.screen.off-left{transform:translateX(-100%)}

/* NAVBAR */
.navbar{flex-shrink:0;background:var(--s1);border-bottom:1px solid var(--s3);padding:10px 14px;padding-top:max(10px,env(safe-area-inset-top));display:flex;align-items:center;gap:8px}
.navbar-title{flex:1;font-size:15px;font-weight:700;color:var(--acc);letter-spacing:.04em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:8px 13px;border-radius:9px;border:none;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;transition:opacity .15s;font-family:inherit}
.btn:active{opacity:.65}
.btn-acc{background:var(--acc);color:#000}
.btn-ghost{background:var(--s2);color:var(--txt);border:1px solid var(--s3)}
.btn-danger{background:var(--danger);color:#fff}
.btn-sm{padding:6px 10px;font-size:12px}
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
input[type=file]{display:none}

/* HOME */
.home-header{margin:14px;background:var(--s1);border-radius:var(--r);padding:14px;border:1px solid var(--s3)}
.home-header input{width:100%;background:var(--s2);border:1px solid var(--s3);border-radius:8px;padding:10px 12px;color:var(--txt);font-size:15px;font-family:inherit;outline:none}
.home-header input:focus{border-color:var(--acc)}
.home-header label{font-size:11px;color:var(--txt2);text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:6px}

/* PLAN LIBRARY */
.plan-section{margin:0 14px 12px}
.plan-section-title{font-size:11px;color:var(--txt2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;padding-left:2px}
.plan-lib-list{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px}
.plan-lib-card{flex-shrink:0;width:100px;background:var(--s1);border:1px solid var(--s3);border-radius:10px;overflow:hidden;cursor:pointer;transition:border-color .2s}
.plan-lib-card:active{border-color:var(--acc)}
.plan-lib-card img{width:100%;height:64px;object-fit:cover;display:block}
.plan-lib-card-name{padding:5px 6px;font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.plan-add-card{flex-shrink:0;width:100px;height:93px;background:var(--s1);border:2px dashed var(--s3);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;color:var(--txt2);font-size:10px;gap:4px;transition:border-color .2s}
.plan-add-card:active{border-color:var(--acc);color:var(--acc)}

.photo-grid{padding:0 12px 80px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
.photo-card{background:var(--s1);border:1px solid var(--s3);border-radius:var(--r);overflow:hidden;cursor:pointer;transition:border-color .2s}
.photo-card:active{border-color:var(--acc)}
.photo-card-thumb{position:relative;aspect-ratio:4/3;background:var(--s2)}
.photo-card-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.plan-dot-badge{position:absolute;bottom:4px;right:4px;width:14px;height:14px;background:var(--acc);border-radius:50%;border:2px solid #000}
.pin-count{position:absolute;top:5px;left:5px;background:var(--acc);color:#000;font-size:10px;font-weight:800;padding:2px 7px;border-radius:999px}
.photo-card-info{padding:8px}
.photo-card-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.photo-card-meta{font-size:10px;color:var(--txt2);margin-top:2px}

.empty{text-align:center;padding:60px 24px;color:var(--txt2)}
.empty-icon{font-size:52px;margin-bottom:14px}

.add-strip{margin:0 12px 12px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
.add-btn{background:var(--s1);border:2px dashed var(--s3);border-radius:var(--r);padding:16px 10px;text-align:center;cursor:pointer;color:var(--txt2);font-size:12px;transition:border-color .2s}
.add-btn:active{border-color:var(--acc);color:var(--acc)}
.add-btn-icon{font-size:26px;margin-bottom:5px}

/* DETAIL */
.img-area{flex-shrink:0;position:relative;background:#000;height:52dvh;display:flex;align-items:center;justify-content:center;overflow:hidden;touch-action:none}
#zoomCanvas{width:100%;height:100%;display:block;touch-action:none}
.zoom-badge{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);color:var(--acc);font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px;pointer-events:none;display:none}

.detail-meta{flex-shrink:0;background:var(--s1);border-bottom:1px solid var(--s3);padding:8px 12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.meta-chip{font-size:11px;color:var(--txt2);background:var(--s2);border-radius:6px;padding:3px 8px}
.meta-chip a{color:var(--acc);text-decoration:none}

.hint-bar{flex-shrink:0;text-align:center;padding:6px;font-size:11px;color:var(--acc);background:rgba(245,166,35,.07);letter-spacing:.03em}

.pin-list{padding:10px;display:flex;flex-direction:column;gap:7px}
.pin-row{background:var(--s1);border:1px solid var(--s3);border-radius:10px;padding:10px 11px;display:flex;align-items:flex-start;gap:9px;cursor:pointer;transition:border-color .15s}
.pin-row.sel{border-color:var(--acc)}
.pin-num{width:24px;height:24px;border-radius:50%;background:var(--acc);color:#000;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.pin-text{flex:1;font-size:13px;line-height:1.45;word-break:break-word}
.pin-text.empty{color:var(--txt2);font-style:italic}
.pin-del{background:none;border:none;color:var(--txt2);font-size:18px;cursor:pointer;padding:0 2px;flex-shrink:0;line-height:1}
.pin-del:active{color:var(--danger)}

/* plan position row in detail */
.plan-pos-row{margin:0 10px 10px;background:var(--s1);border:1px solid var(--s3);border-radius:10px;overflow:hidden;cursor:pointer;display:flex;align-items:center;gap:10px;padding:8px;transition:border-color .2s}
.plan-pos-row:active{border-color:var(--acc)}
.plan-pos-preview{width:72px;height:54px;position:relative;flex-shrink:0;border-radius:6px;overflow:hidden;background:var(--s2)}
.plan-pos-preview img{width:100%;height:100%;object-fit:cover;display:block}
.plan-pos-dot{position:absolute;width:12px;height:12px;background:var(--danger);border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 1px 4px rgba(0,0,0,.6)}
.plan-pos-label{font-size:12px;color:var(--txt2);flex:1;line-height:1.4}
.plan-pos-label strong{color:var(--txt);display:block;margin-bottom:2px}

/* PLAN PICKER */
#scrPlan .plan-img-wrap{position:relative;background:#000;flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden}
#planPickImg{max-width:100%;max-height:100%;display:block;pointer-events:none;user-select:none}
.plan-tap-layer{position:absolute;inset:0;cursor:crosshair}
.plan-pick-dot{position:absolute;width:22px;height:22px;background:var(--danger);border:3px solid #fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 2px 8px rgba(0,0,0,.7);pointer-events:none;z-index:5}
.plan-hint{flex-shrink:0;text-align:center;padding:10px;font-size:13px;color:var(--acc);background:rgba(245,166,35,.07)}
.plan-actions{flex-shrink:0;padding:12px;display:flex;gap:8px;background:var(--s1);border-top:1px solid var(--s3)}

/* PLAN SELECT */
.plan-select-list{padding:14px;display:flex;flex-direction:column;gap:10px}
.plan-select-card{background:var(--s1);border:1px solid var(--s3);border-radius:var(--r);overflow:hidden;cursor:pointer;display:flex;align-items:center;gap:12px;padding:10px;transition:border-color .2s}
.plan-select-card:active{border-color:var(--acc)}
.plan-select-card img{width:80px;height:56px;object-fit:cover;border-radius:8px;flex-shrink:0}
.plan-select-card .plan-select-name{font-size:14px;font-weight:600;flex:1}

/* SHEETS */
.sheet-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;align-items:flex-end}
.sheet-overlay.open{display:flex}
.sheet{width:100%;background:var(--s1);border-radius:18px 18px 0 0;padding:14px;animation:su .22s ease-out;max-height:80vh;overflow-y:auto}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-title{font-size:13px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px}
.sheet-input{width:100%;background:var(--s2);border:1px solid var(--s3);border-radius:9px;padding:10px 12px;color:var(--txt);font-size:15px;font-family:inherit;resize:none;outline:none;min-height:80px}
.sheet-input:focus{border-color:var(--acc)}
.sheet-input-line{min-height:auto;padding:12px}
.sheet-row{display:flex;gap:8px;margin-top:10px}

/* EXPORT */
.export-body{padding:14px;display:flex;flex-direction:column;gap:12px}
.stat-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stat-box{background:var(--s1);border:1px solid var(--s3);border-radius:var(--r);padding:14px;text-align:center}
.stat-n{font-size:32px;font-weight:800;color:var(--acc)}
.stat-l{font-size:11px;color:var(--txt2);text-transform:uppercase;letter-spacing:.05em;margin-top:2px}
.info-box{background:var(--s1);border:1px solid var(--s3);border-radius:var(--r);padding:14px;font-size:13px;color:var(--txt2);line-height:1.7}
.info-box strong{color:var(--txt)}
.big-btn{width:100%;padding:15px;font-size:15px;border-radius:var(--r)}

/* CALIBRATION MODE */
.mode-active{background:#2196F3!important;color:#fff!important;border-color:#1976D2!important}
.cal-pin-row{background:var(--s1);border:1px solid #2196F3;border-radius:10px;padding:10px 11px;display:flex;align-items:flex-start;gap:9px;cursor:pointer;transition:border-color .15s}
.cal-pin-row.sel{border-color:#fff;box-shadow:0 0 0 2px #2196F3}
.cal-num{width:24px;height:24px;border-radius:50%;background:#2196F3;color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cal-section-title{font-size:11px;color:#2196F3;text-transform:uppercase;letter-spacing:.06em;margin:12px 0 6px;padding-left:2px;font-weight:700}
</style>
</head>
<body>

<!-- ‚ïê‚ïê HOME ‚ïê‚ïê -->
<div class="screen" id="scrHome">
  <div class="navbar">
    <span class="navbar-title">üèó Inspektor v5_6</span>
    <button class="btn btn-ghost btn-sm" onclick="showExport()">Export</button>
  </div>
  <div class="scroll">
    <div class="home-header">
      <label>N√°zev prohl√≠dky</label>
      <input type="text" id="projectName" placeholder="nap≈ô. Bytov√Ω d≈Øm Korunn√≠ 15" oninput="saveProjectName()">
      <div style="margin-top:8px;font-size:11px;color:var(--txt2)" id="projectDate"></div>
    </div>

    <!-- PLAN LIBRARY -->
    <div class="plan-section">
      <div class="plan-section-title">üìã Pl√°nky</div>
      <div class="plan-lib-list" id="planLibList">
        <div class="plan-add-card" onclick="document.getElementById('filePlan').click()">
          <div style="font-size:22px">+</div>
          <div>P≈ôidat pl√°nek</div>
        </div>
      </div>
    </div>
    <input type="file" id="filePlan" accept="image/*" onchange="handleAddPlan(event)">

    <div class="add-strip">
      <div class="add-btn" onclick="document.getElementById('filePhoto').click()">
        <div class="add-btn-icon">üì∑</div>
        <div>P≈ôidat fotku</div>
        <div style="font-size:10px;margin-top:2px">z galerie</div>
      </div>
      <div class="add-btn" onclick="document.getElementById('fileCamera').click()">
        <div class="add-btn-icon">üì∏</div>
        <div>Vyfotit teƒè</div>
        <div style="font-size:10px;margin-top:2px">fotoapar√°t</div>
      </div>
    </div>
    <input type="file" id="filePhoto" accept="image/*" multiple onchange="handleFiles(event)">
    <input type="file" id="fileCamera" accept="image/*" capture="environment" onchange="handleFiles(event)">

    <div class="photo-grid" id="photoGrid"></div>
    <div class="empty" id="emptyState">
      <div class="empty-icon">üè†</div>
      <div>Zat√≠m ≈æ√°dn√© fotky.<br>P≈ôidejte prvn√≠ fotografii.</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê DETAIL ‚ïê‚ïê -->
<div class="screen off-right" id="scrDetail">
  <div class="navbar" style="gap:6px">
    <button class="btn btn-ghost btn-sm" onclick="goHome()" style="padding:6px 8px">‚Üê</button>
    <button class="btn btn-ghost btn-sm" id="btnPrev" onclick="prevPhoto()" style="padding:6px 8px">‚Äπ</button>
    <span class="navbar-title" id="detailTitle" style="font-size:13px">‚Äî</span>
    <button class="btn btn-ghost btn-sm" id="btnNext" onclick="nextPhoto()" style="padding:6px 8px">‚Ä∫</button>
    <button class="btn btn-acc btn-sm" onclick="document.getElementById('fileCamera').click()" style="padding:6px 10px">+ Foto</button>
    <button class="btn btn-danger btn-sm" onclick="deletePhoto()" style="padding:6px 8px">üóë</button>
  </div>
  <div class="img-area" id="imgArea">
    <canvas id="zoomCanvas"></canvas>
    <div class="zoom-badge" id="zoomBadge">1.0√ó</div>
  </div>
  <div class="detail-meta" id="detailMeta"></div>
  <div class="hint-bar" id="hintBar" style="display:flex;align-items:center;justify-content:center;gap:10px">
    <span id="hintText">Klepnƒõte na fotku ‚Üí p≈ôidejte bod s pozn√°mkou</span>
    <button class="btn btn-sm" id="modeBtn" onclick="toggleMode()" style="padding:4px 10px;font-size:11px;background:var(--s2);color:var(--txt);border:1px solid var(--s3)">üìè Mƒõ≈ôen√≠</button>
  </div>
  <div class="scroll" id="pinScroll">
    <div id="planPosRow"></div>
    <div class="pin-list" id="pinList"></div>
    <div style="height:10px"></div>
  </div>
</div>

<!-- ‚ïê‚ïê PLAN SELECT ‚ïê‚ïê -->
<div class="screen off-right" id="scrPlanSelect">
  <div class="navbar">
    <button class="btn btn-ghost btn-sm" onclick="goTo('scrDetail')">‚Üê Zpƒõt</button>
    <span class="navbar-title">Vyberte pl√°nek</span>
  </div>
  <div class="scroll">
    <div class="plan-select-list" id="planSelectList"></div>
  </div>
</div>

<!-- ‚ïê‚ïê PLAN PICKER ‚ïê‚ïê -->
<div class="screen off-right" id="scrPlan">
  <div class="navbar">
    <button class="btn btn-ghost btn-sm" onclick="cancelPlanPick()">‚Üê Zpƒõt</button>
    <span class="navbar-title" id="planPickTitle">Kde jste na pl√°nku?</span>
  </div>
  <div class="plan-hint">Klepnƒõte na m√≠sto kde stoj√≠te ‚Üí automaticky ulo≈æ√≠</div>
  <div class="plan-img-wrap" id="planImgWrap" style="touch-action:none">
    <canvas id="planCanvas" style="width:100%;height:100%;display:block;touch-action:none"></canvas>
    <div class="zoom-badge" id="planZoomBadge" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);color:var(--acc);font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px;pointer-events:none;display:none"></div>
  </div>
  <div class="plan-actions">
    <button class="btn btn-ghost" style="flex:1" onclick="cancelPlanPick()">‚Üê Zpƒõt</button>
    <button class="btn btn-danger" style="flex:2" onclick="clearAndSavePlanPos()">Vymazat pozici</button>
  </div>
</div>

<!-- ‚ïê‚ïê EXPORT ‚ïê‚ïê -->
<div class="screen off-right" id="scrExport">
  <div class="navbar">
    <button class="btn btn-ghost btn-sm" onclick="goHome()">‚Üê Zpƒõt</button>
    <span class="navbar-title">Export dat</span>
  </div>
  <div class="scroll">
    <div class="export-body">
      <div class="stat-row">
        <div class="stat-box"><div class="stat-n" id="eStat1">0</div><div class="stat-l">Fotografi√≠</div></div>
        <div class="stat-box"><div class="stat-n" id="eStat2">0</div><div class="stat-l">Pozn√°mek</div></div>
      </div>
      <div class="info-box">
        <strong>Jak p≈ôen√©st na PC:</strong><br>
        1. Klepnƒõte "Exportovat ZIP"<br>
        2. Soubor ulo≈æte / sd√≠lejte<br>
        3. Na PC rozbalte ZIP<br>
        4. Otev≈ôete <strong>report.html</strong> v prohl√≠≈æeƒçi
      </div>
      <button class="btn btn-acc big-btn" onclick="doExport()" id="exportBtn">‚¨á Exportovat ZIP</button>
      <button class="btn btn-ghost big-btn" onclick="deletePhoto_confirmAll()">üóë Smazat v≈°e</button>
    </div>
  </div>
</div>

<!-- NOTE SHEET -->
<div class="sheet-overlay" id="noteSheet" onclick="sheetBg(event,'noteSheet')">
  <div class="sheet">
    <div class="sheet-title" id="sheetTitle">Pozn√°mka</div>
    <textarea class="sheet-input" id="noteTA" placeholder="Rozmƒõr, materi√°l, stav‚Ä¶" rows="3"></textarea>
    <div class="sheet-row">
      <button class="btn btn-ghost" style="flex:1" onclick="closeSheet('noteSheet')">Zru≈°it</button>
      <button class="btn btn-acc" style="flex:2" onclick="savePin()">Ulo≈æit</button>
    </div>
  </div>
</div>

<!-- NAME SHEET -->
<div class="sheet-overlay" id="nameSheet" onclick="sheetBg(event,'nameSheet')">
  <div class="sheet">
    <div class="sheet-title">N√°zev fotky</div>
    <input class="sheet-input sheet-input-line" id="nameInput" placeholder="nap≈ô. Fas√°da jih, Okno 2NP‚Ä¶" onkeydown="if(event.key==='Enter'){saveName(false);event.preventDefault()}">
    <div class="sheet-row">
      <button class="btn btn-ghost" style="flex:1" onclick="closeSheet('nameSheet')">Zru≈°it</button>
      <button class="btn btn-ghost" style="flex:2" onclick="saveName(true)">Ulo≈æit + dal≈°√≠ foto üì∑</button>
      <button class="btn btn-acc" style="flex:1" onclick="saveName(false)">OK</button>
    </div>
  </div>
</div>

<!-- PLAN NAME SHEET -->
<div class="sheet-overlay" id="planNameSheet" onclick="sheetBg(event,'planNameSheet')">
  <div class="sheet">
    <div class="sheet-title">N√°zev pl√°nku</div>
    <input class="sheet-input sheet-input-line" id="planNameInput" placeholder="nap≈ô. 2.NP, St≈ôecha, Sklep‚Ä¶" onkeydown="if(event.key==='Enter'){savePlanName();event.preventDefault()}">
    <div class="sheet-row">
      <button class="btn btn-ghost" style="flex:1" onclick="cancelPlanAdd()">Zru≈°it</button>
      <button class="btn btn-acc" style="flex:2" onclick="savePlanName()">Ulo≈æit</button>
    </div>
  </div>
</div>

<!-- CALIBRATION SHEET -->
<div class="sheet-overlay" id="calSheet" onclick="sheetBg(event,'calSheet')">
  <div class="sheet">
    <div class="sheet-title" style="color:#2196F3" id="calSheetTitle">üìè Kalibraƒçn√≠ bod</div>
    <div style="font-size:12px;color:var(--txt2);margin-bottom:8px">Vzd√°lenost od objektivu k tomuto bodu v mm</div>
    <input class="sheet-input sheet-input-line" id="calDistInput" type="number" inputmode="numeric" placeholder="nap≈ô. 8500" onkeydown="if(event.key==='Enter'){saveCalPin();event.preventDefault()}">
    <div class="sheet-row">
      <button class="btn btn-ghost" style="flex:1" onclick="closeSheet('calSheet')">Zru≈°it</button>
      <button class="btn" style="flex:2;background:#2196F3;color:#fff" onclick="saveCalPin()">Ulo≈æit</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE SHEET -->
<div class="sheet-overlay" id="confirmSheet" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="sheet">
    <div class="sheet-title" style="color:var(--danger)" id="confirmSheetTitle">Smazat?</div>
    <div style="font-size:14px;color:var(--txt2);margin-bottom:14px" id="confirmSheetMsg">Opravdu smazat?</div>
    <div class="sheet-row">
      <button class="btn btn-ghost" style="flex:1" onclick="document.getElementById('confirmSheet').classList.remove('open')">Zru≈°it</button>
      <button class="btn btn-danger" style="flex:2" id="confirmSheetBtn" onclick="">Smazat</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB='stavba4', DBV=1;
let db, photos=[], plans=[], projectName='', projectDate='';

function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB,DBV);
    r.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('photos')) d.createObjectStore('photos',{keyPath:'id'});
      if(!d.objectStoreNames.contains('meta'))   d.createObjectStore('meta',{keyPath:'k'});
      if(!d.objectStoreNames.contains('plans'))  d.createObjectStore('plans',{keyPath:'id'});
    };
    r.onsuccess=e=>{db=e.target.result;res()};
    r.onerror=rej;
  });
}
function dbAll(s){return new Promise((res,rej)=>{const r=db.transaction(s,'readonly').objectStore(s).getAll();r.onsuccess=()=>res(r.result);r.onerror=rej;})}
function dbPut(s,o){return new Promise((res,rej)=>{const r=db.transaction(s,'readwrite').objectStore(s).put(o);r.onsuccess=res;r.onerror=rej;})}
function dbDel(s,k){return new Promise((res,rej)=>{const r=db.transaction(s,'readwrite').objectStore(s).delete(k);r.onsuccess=res;r.onerror=rej;})}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastGPS=null;
function startGPS(){
  if(!navigator.geolocation)return;
  navigator.geolocation.watchPosition(p=>{lastGPS={lat:p.coords.latitude.toFixed(6),lng:p.coords.longitude.toFixed(6),acc:Math.round(p.coords.accuracy)}},()=>{},{enableHighAccuracy:true,maximumAge:10000});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
openDB().then(async()=>{
  photos=await dbAll('photos');
  photos.sort((a,b)=>a.ts-b.ts);
  plans=await dbAll('plans');
  plans.sort((a,b)=>a.ts-b.ts);
  const metas=await dbAll('meta');
  const pn=metas.find(m=>m.k==='projectName');
  const pd=metas.find(m=>m.k==='projectDate');
  if(pn){projectName=pn.v;document.getElementById('projectName').value=pn.v;}
  if(pd){projectDate=pd.v;}else{projectDate=fmtDate(new Date());dbPut('meta',{k:'projectDate',v:projectDate});}
  document.getElementById('projectDate').textContent='Zah√°jeno: '+projectDate;
  renderGrid();
  renderPlanLib();
  startGPS();
});

function saveProjectName(){projectName=document.getElementById('projectName').value;dbPut('meta',{k:'projectName',v:projectName});}
function fmtDate(d){return d.toLocaleDateString('cs-CZ')+' '+d.toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'});}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goTo(id){
  document.querySelectorAll('.screen').forEach(s=>{
    s.classList.remove('off-right','off-left');
    if(s.id!==id) s.classList.add(s.id==='scrHome'?'off-left':'off-right');
  });
  document.getElementById(id).classList.remove('off-right','off-left');
}
function goHome(){goTo('scrHome');}
function showExport(){
  document.getElementById('eStat1').textContent=photos.length;
  document.getElementById('eStat2').textContent=photos.reduce((s,p)=>s+p.pins.length,0);
  goTo('scrExport');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAN LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pendingPlanDataUrl=null;

function renderPlanLib(){
  const list=document.getElementById('planLibList');
  list.innerHTML=plans.map(pl=>`
    <div class="plan-lib-card" onclick="showPlanOptions('${pl.id}')">
      <img src="${pl.dataUrl}" loading="lazy">
      <div class="plan-lib-card-name">${esc(pl.name)}</div>
    </div>
  `).join('')+`
    <div class="plan-add-card" onclick="document.getElementById('filePlan').click()">
      <div style="font-size:22px">+</div>
      <div>P≈ôidat pl√°nek</div>
    </div>
  `;
}

function handleAddPlan(e){
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=async ev=>{
    pendingPlanDataUrl=await compressImage(ev.target.result,800,0.75);
    document.getElementById('planNameInput').value='';
    document.getElementById('planNameSheet').classList.add('open');
    setTimeout(()=>document.getElementById('planNameInput').focus(),250);
  };
  reader.readAsDataURL(f);
  e.target.value='';
}
function cancelPlanAdd(){
  pendingPlanDataUrl=null;
  closeSheet('planNameSheet');
}
async function savePlanName(){
  const name=document.getElementById('planNameInput').value.trim()||'Pl√°nek '+(plans.length+1);
  if(!pendingPlanDataUrl)return;
  const plan={id:Date.now()+Math.random(),ts:Date.now(),name,dataUrl:pendingPlanDataUrl};
  plans.push(plan);
  await dbPut('plans',plan);
  pendingPlanDataUrl=null;
  closeSheet('planNameSheet');
  renderPlanLib();
}

function showPlanOptions(planId){
  const pl=plans.find(x=>x.id==planId);
  if(!pl)return;
  document.getElementById('confirmSheetTitle').textContent='Pl√°nek: '+pl.name;
  document.getElementById('confirmSheetMsg').textContent='Smazat tento pl√°nek? Pozice u fotek p≈ôi≈ôazen√Ωch k tomuto pl√°nku se odstran√≠.';
  document.getElementById('confirmSheetBtn').onclick=async()=>{
    // remove plan and all references
    plans=plans.filter(x=>x.id!=planId);
    await dbDel('plans',planId);
    for(const p of photos){
      if(p.planId==planId){p.planId=null;p.planPos=null;await dbPut('photos',p);}
    }
    document.getElementById('confirmSheet').classList.remove('open');
    renderPlanLib();renderGrid();
  };
  document.getElementById('confirmSheet').classList.add('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD PHOTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleFiles(evt){
  const files=Array.from(evt.target.files);if(!files.length)return;
  const gps=lastGPS?{...lastGPS}:null;
  files.forEach(f=>readFile(f,gps));
  evt.target.value='';
}
function readFile(file,gps){
  const reader=new FileReader();
  reader.onload=async e=>{
    const rawDataUrl=e.target.result;
    const focalInfo=extractFocalLength(rawDataUrl);
    const compressed=await compressImage(rawDataUrl,1600,0.8);
    const ts=Date.now();
    const photo={id:ts+Math.random(),ts,name:'',dataUrl:compressed,gps,time:fmtDate(new Date(ts)),pins:[],calPins:[],planId:null,planPos:null,focal:focalInfo};
    photos.push(photo);
    await dbPut('photos',photo);
    renderGrid();
    openDetail(photo.id,true);
  };
  reader.readAsDataURL(file);
}

// Extract focal length from JPEG EXIF (basic parser)
function extractFocalLength(dataUrl){
  try{
    const bin=atob(dataUrl.split(',')[1]);
    const arr=new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);
    // Check JPEG SOI + APP1
    if(arr[0]!==0xFF||arr[1]!==0xD8)return null;
    let offset=2;
    while(offset<arr.length-4){
      if(arr[offset]!==0xFF)break;
      const marker=arr[offset+1];
      const len=(arr[offset+2]<<8)|arr[offset+3];
      if(marker===0xE1){ // APP1 = EXIF
        return parseExifFocal(arr,offset+4,len-2);
      }
      offset+=2+len;
    }
  }catch(e){}
  return null;
}

function parseExifFocal(arr,start,len){
  try{
    // Check "Exif\0\0"
    const exifStr=String.fromCharCode(arr[start],arr[start+1],arr[start+2],arr[start+3]);
    if(exifStr!=='Exif')return null;
    const tiffStart=start+6;
    const le=arr[tiffStart]===0x49; // little endian
    const r=(o,n)=>{
      if(n===2)return le?(arr[o]|arr[o+1]<<8):(arr[o]<<8|arr[o+1]);
      return le?(arr[o]|arr[o+1]<<8|arr[o+2]<<16|arr[o+3]<<24):(arr[o]<<24|arr[o+1]<<16|arr[o+2]<<8|arr[o+3]);
    };
    // Parse IFD0
    const ifd0off=tiffStart+r(tiffStart+4,4);
    const n0=r(ifd0off,2);
    let exifIFDoff=0;
    for(let i=0;i<n0;i++){
      const eoff=ifd0off+2+i*12;
      const tag=r(eoff,2);
      if(tag===0x8769){exifIFDoff=tiffStart+r(eoff+8,4);break;} // ExifIFD pointer
    }
    if(!exifIFDoff)return null;
    // Parse ExifIFD for FocalLength(0xA405=35mm equiv, 0x920A=focal)
    const ne=r(exifIFDoff,2);
    let focal35=null, focalRaw=null;
    for(let i=0;i<ne;i++){
      const eoff=exifIFDoff+2+i*12;
      const tag=r(eoff,2);
      if(tag===0xA405){focal35=r(eoff+8,2);} // FocalLengthIn35mmFilm
      if(tag===0x920A){ // FocalLength (rational)
        const voff=tiffStart+r(eoff+8,4);
        const num=r(voff,4), den=r(voff+4,4);
        if(den>0)focalRaw=Math.round(num/den*10)/10;
      }
    }
    return {focal35:focal35||null, focalRaw:focalRaw||null};
  }catch(e){}
  return null;
}

function compressImage(dataUrl,maxPx,quality){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.naturalWidth, h=img.naturalHeight;
      if(w>maxPx||h>maxPx){
        if(w>h){h=Math.round(h*maxPx/w);w=maxPx;}
        else{w=Math.round(w*maxPx/h);h=maxPx;}
      }
      const c=document.createElement('canvas');
      c.width=w;c.height=h;
      const ctx=c.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      res(c.toDataURL('image/jpeg',quality));
    };
    img.src=dataUrl;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGrid(){
  const grid=document.getElementById('photoGrid');
  const empty=document.getElementById('emptyState');
  empty.style.display=photos.length?'none':'block';
  grid.innerHTML=photos.map(p=>`
    <div class="photo-card" onclick="openDetail('${p.id}')">
      <div class="photo-card-thumb">
        <img src="${p.dataUrl}" loading="lazy">
        ${p.planPos?'<div class="plan-dot-badge"></div>':''}
        <div class="pin-count">${p.pins.length} b</div>
      </div>
      <div class="photo-card-info">
        <div class="photo-card-name">${p.name?esc(p.name):'<em style="color:var(--txt2)">bez n√°zvu</em>'}</div>
        <div class="photo-card-meta">${p.time}</div>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS ZOOM ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas=document.getElementById('zoomCanvas');
const ctx=canvas.getContext('2d');
let cImg=null;          // current Image object
let cScale=1, cMinScale=1, cMaxScale=20;
let cOffX=0, cOffY=0;   // pan offset in image pixels
let cImgW=0, cImgH=0;   // natural image size
let cFitW=0, cFitH=0;   // fitted size at scale=1
let cFitOX=0, cFitOY=0; // offset to center fitted image in canvas

// touch state
let tch={}, gesture='none', pinchDist0=0, pinchScale0=1, panStart=null, panOff0=null;
let tapStart=0, tapXY=null, moved=false;

function cDraw(){
  const dpr=window.devicePixelRatio||1;
  const cw=canvas.clientWidth, ch=canvas.clientHeight;
  if(canvas.width!==cw*dpr||canvas.height!==ch*dpr){canvas.width=cw*dpr;canvas.height=ch*dpr;}
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,cw,ch);
  if(!cImg||!cImg.complete)return;

  const sw=cFitW*cScale, sh=cFitH*cScale;
  const dx=cFitOX - cOffX*cScale*(cFitW/cImgW);
  const dy=cFitOY - cOffY*cScale*(cFitH/cImgH);
  ctx.drawImage(cImg,dx,dy,sw,sh);

  // draw documentation pins (yellow)
  const p=getP(); if(!p)return;
  p.pins.forEach((pin,i)=>{
    const px=dx+pin.x/100*sw;
    const py=dy+pin.y/100*sh;
    ctx.beginPath();ctx.arc(px,py,14,0,Math.PI*2);
    ctx.fillStyle='#f5a623';ctx.fill();
    ctx.strokeStyle='#000';ctx.lineWidth=2.5;ctx.stroke();
    ctx.fillStyle='#000';ctx.font='bold 11px -apple-system,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(String(i+1),px,py+0.5);
  });

  // draw calibration pins (blue)
  const calPins=p.calPins||[];
  calPins.forEach((pin,i)=>{
    const px=dx+pin.x/100*sw;
    const py=dy+pin.y/100*sh;
    ctx.beginPath();ctx.arc(px,py,14,0,Math.PI*2);
    ctx.fillStyle='#2196F3';ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=2.5;ctx.stroke();
    ctx.fillStyle='#fff';ctx.font='bold 9px -apple-system,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('K'+(i+1),px,py+0.5);
  });

  // zoom badge
  const badge=document.getElementById('zoomBadge');
  if(cScale>1.05){badge.textContent=cScale.toFixed(1)+'√ó';badge.style.display='block';}
  else{badge.style.display='none';}
}

function cLoadImage(dataUrl){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      cImg=img; cImgW=img.naturalWidth; cImgH=img.naturalHeight;
      cResetView();
      res();
    };
    img.src=dataUrl;
  });
}

function cResetView(){
  cScale=1;cOffX=0;cOffY=0;
  const cw=canvas.clientWidth, ch=canvas.clientHeight;
  const ratioW=cw/cImgW, ratioH=ch/cImgH;
  const fit=Math.min(ratioW,ratioH);
  cFitW=cImgW*fit; cFitH=cImgH*fit;
  cFitOX=(cw-cFitW)/2; cFitOY=(ch-cFitH)/2;
  cMinScale=1;
  cDraw();
}

function cClamp(){
  if(cScale<cMinScale)cScale=cMinScale;
  if(cScale>cMaxScale)cScale=cMaxScale;
  // clamp pan so image stays within view
  const maxOX=cImgW*(1-1/cScale)/2;
  const maxOY=cImgH*(1-1/cScale)/2;
  if(maxOX>0){cOffX=Math.max(-maxOX,Math.min(maxOX,cOffX));}else{cOffX=0;}
  if(maxOY>0){cOffY=Math.max(-maxOY,Math.min(maxOY,cOffY));}else{cOffY=0;}
}

// convert canvas client coords to image % coords
function cClientToImgPct(cx,cy){
  const rect=canvas.getBoundingClientRect();
  const x=cx-rect.left, y=cy-rect.top;
  const sw=cFitW*cScale, sh=cFitH*cScale;
  const dx=cFitOX - cOffX*cScale*(cFitW/cImgW);
  const dy=cFitOY - cOffY*cScale*(cFitH/cImgH);
  const pctX=(x-dx)/sw*100;
  const pctY=(y-dy)/sh*100;
  if(pctX<0||pctX>100||pctY<0||pctY>100)return null;
  return {x:pctX,y:pctY};
}

function dist(a,b){return Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);}

canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const touches=e.touches;
  if(touches.length===1){
    gesture='pan';
    panStart={x:touches[0].clientX,y:touches[0].clientY};
    panOff0={x:cOffX,y:cOffY};
    tapStart=Date.now();
    tapXY={x:touches[0].clientX,y:touches[0].clientY};
    moved=false;
  } else if(touches.length===2){
    gesture='pinch';
    pinchDist0=dist(touches[0],touches[1]);
    pinchScale0=cScale;
    moved=true; // not a tap
  }
},{passive:false});

canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  const touches=e.touches;
  if(gesture==='pan'&&touches.length===1){
    const dx=touches[0].clientX-panStart.x;
    const dy=touches[0].clientY-panStart.y;
    if(Math.abs(dx)>4||Math.abs(dy)>4)moved=true;
    if(cScale>1.05){
      // convert screen px to image px
      const factor=cImgW/cFitW/cScale;
      cOffX=panOff0.x-dx*factor;
      cOffY=panOff0.y-dy*factor;
      cClamp();cDraw();
    }
  } else if(gesture==='pinch'&&touches.length===2){
    const d=dist(touches[0],touches[1]);
    cScale=pinchScale0*(d/pinchDist0);
    cClamp();cDraw();
  }
},{passive:false});

canvas.addEventListener('touchend',e=>{
  e.preventDefault();
  if(e.touches.length===0){
    if(!moved && (Date.now()-tapStart)<350 && tapXY){
      handleCanvasTap(tapXY.x,tapXY.y);
    }
    gesture='none';
  } else if(e.touches.length===1){
    // went from pinch to single finger ‚Äì reset pan origin
    gesture='pan';
    panStart={x:e.touches[0].clientX,y:e.touches[0].clientY};
    panOff0={x:cOffX,y:cOffY};
  }
},{passive:false});

// mouse fallback for testing on desktop
canvas.addEventListener('click',e=>{
  handleCanvasTap(e.clientX,e.clientY);
});
canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  const delta=e.deltaY>0?0.9:1.1;
  cScale*=delta;cClamp();cDraw();
},{passive:false});

window.addEventListener('resize',()=>{
  // only auto-reset if no sheet is open (keyboard not active)
  const sheetOpen=document.querySelector('.sheet-overlay.open');
  if(cImg && !sheetOpen) cResetView();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let curId=null, editPinId=null, pendingXY=null;
let calMode=false; // false=documentation, true=calibration

function toggleMode(){
  calMode=!calMode;
  const btn=document.getElementById('modeBtn');
  const hint=document.getElementById('hintText');
  if(calMode){
    btn.classList.add('mode-active');
    btn.textContent='üìù Pozn√°mky';
    hint.textContent='üìè Mƒö≈òEN√ç ‚Äì klepnƒõte na bod a zadejte vzd√°lenost v mm';
    document.getElementById('hintBar').style.background='rgba(33,150,243,.12)';
  } else {
    btn.classList.remove('mode-active');
    btn.textContent='üìè Mƒõ≈ôen√≠';
    hint.textContent='Klepnƒõte na fotku ‚Üí p≈ôidejte bod s pozn√°mkou';
    document.getElementById('hintBar').style.background='rgba(245,166,35,.07)';
  }
}

function openDetail(id,promptName){
  curId=id;
  calMode=false;
  document.getElementById('modeBtn').classList.remove('mode-active');
  document.getElementById('modeBtn').textContent='üìè Mƒõ≈ôen√≠';
  document.getElementById('hintText').textContent='Klepnƒõte na fotku ‚Üí p≈ôidejte bod s pozn√°mkou';
  document.getElementById('hintBar').style.background='rgba(245,166,35,.07)';
  const p=photos.find(x=>x.id==id);
  document.getElementById('detailTitle').textContent=p.name||'bez n√°zvu';
  renderDetailMeta(p);
  renderPinList(p);
  updateNavBtns();
  goTo('scrDetail');
  canvas.width=0;canvas.height=0;
  requestAnimationFrame(()=>{
    cLoadImage(p.dataUrl);
  });
  if(promptName) setTimeout(()=>openNameSheet(p),400);
}
function getP(){return photos.find(x=>x.id==curId);}

function renderDetailMeta(p){
  let html=`<span class="meta-chip">üïê ${p.time}</span>`;
  if(p.gps) html+=`<span class="meta-chip"><a href="https://www.google.com/maps?q=${p.gps.lat},${p.gps.lng}" target="_blank">üìç ${p.gps.lat}, ${p.gps.lng} ¬±${p.gps.acc}m</a></span>`;
  else html+=`<span class="meta-chip" style="color:var(--txt2)">üìç GPS nedostupn√©</span>`;
  if(p.focal){
    const f35=p.focal.focal35;
    const fr=p.focal.focalRaw;
    let ftext=f35?f35+'mm(35)':'';
    if(fr)ftext+=(ftext?' / ':'')+fr+'mm';
    if(ftext)html+=`<span class="meta-chip">üî≠ ${ftext}</span>`;
    if(f35 && f35!==26 && f35!==28)html+=`<span class="meta-chip" style="background:#ff3b3033;color:#ff3b30">‚ö† nen√≠ standardn√≠ objektiv</span>`;
  }
  document.getElementById('detailMeta').innerHTML=html;
}

function handleCanvasTap(cx,cy){
  const pct=cClientToImgPct(cx,cy);
  if(!pct)return;
  pendingXY={x:pct.x,y:pct.y};
  editPinId=null;
  const p=getP();
  if(calMode){
    // calibration mode ‚Äì open distance sheet
    if(!p.calPins)p.calPins=[];
    document.getElementById('calSheetTitle').textContent=`üìè Kalibraƒçn√≠ bod ${p.calPins.length+1}`;
    document.getElementById('calDistInput').value='';
    document.getElementById('calSheet').classList.add('open');
  } else {
    // documentation mode
    document.getElementById('sheetTitle').textContent=`Nov√Ω bod ${p.pins.length+1}`;
    document.getElementById('noteTA').value='';
    document.getElementById('noteSheet').classList.add('open');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALIBRATION PINS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editCalPinId=null;

async function saveCalPin(){
  const dist=parseInt(document.getElementById('calDistInput').value);
  if(!dist||dist<=0){closeSheet('calSheet');return;}
  const p=getP();
  if(!p.calPins)p.calPins=[];
  if(editCalPinId){
    const pin=p.calPins.find(x=>x.id==editCalPinId);
    if(pin)pin.dist=dist;
  } else if(pendingXY){
    p.calPins.push({id:Date.now()+Math.random(),x:pendingXY.x,y:pendingXY.y,dist});
  }
  await dbPut('photos',p);
  closeSheet('calSheet');
  document.activeElement&&document.activeElement.blur();
  waitForViewportStable(()=>{
    cScale=1;cOffX=0;cOffY=0;
    cResetView();
    renderPinList(p);
  });
}

function editCalPin(pinId){
  const p=getP(); const pin=p.calPins.find(x=>x.id==pinId);
  editCalPinId=pinId; pendingXY=null;
  const i=p.calPins.indexOf(pin)+1;
  document.getElementById('calSheetTitle').textContent=`üìè Kalibraƒçn√≠ bod ${i} ‚Äì upravit`;
  document.getElementById('calDistInput').value=pin.dist||'';
  document.getElementById('calSheet').classList.add('open');
}

async function delCalPin(e,pinId){
  e.stopPropagation();
  const p=getP(); p.calPins=p.calPins.filter(x=>x.id!=pinId);
  await dbPut('photos',p); cDraw(); renderPinList(p);
}

function renderPinList(p){
  // Plan position row
  const pr=document.getElementById('planPosRow');
  if(plans.length>0){
    const hasPlan=p.planId && plans.find(x=>x.id==p.planId);
    const planObj=hasPlan?plans.find(x=>x.id==p.planId):null;
    if(hasPlan && p.planPos){
      pr.innerHTML=`<div class="plan-pos-row" onclick="openPlanPicker()">
        <div class="plan-pos-preview">
          <img src="${planObj.dataUrl}">
          <div class="plan-pos-dot" style="left:${p.planPos.x}%;top:${p.planPos.y}%"></div>
        </div>
        <div class="plan-pos-label">
          <strong>${esc(planObj.name)} ‚Äì pozice oznaƒçena</strong>
          Klepnƒõte pro zmƒõnu
        </div>
      </div>`;
    } else {
      pr.innerHTML=`<div class="plan-pos-row" onclick="openPlanSelect()">
        <div class="plan-pos-preview" style="display:flex;align-items:center;justify-content:center;font-size:20px">üìã</div>
        <div class="plan-pos-label">
          <strong>Oznaƒçit pozici na pl√°nku</strong>
          Vyberte pl√°nek a klepnƒõte kde stoj√≠te
        </div>
      </div>`;
    }
  } else {
    pr.innerHTML=`<div style="margin:0 10px 8px;font-size:12px;color:var(--txt2);padding:8px;background:var(--s1);border-radius:8px;border:1px solid var(--s3)">
      ‚ÑπÔ∏è Nahrajte pl√°nky na hlavn√≠ obrazovce pro oznaƒçen√≠ pozice.
    </div>`;
  }

  const list=document.getElementById('pinList');
  let html='';

  // documentation pins
  if(p.pins.length){
    html+=p.pins.map((pin,i)=>`
      <div class="pin-row ${editPinId==pin.id?'sel':''}" id="pr-${pin.id}" onclick="editPin('${pin.id}')">
        <div class="pin-num">${i+1}</div>
        <div class="pin-text ${pin.text?'':'empty'}">${pin.text?esc(pin.text):'klepnƒõte pro text'}</div>
        <button class="pin-del" onclick="delPin(event,'${pin.id}')">‚úï</button>
      </div>
    `).join('');
  }

  // calibration pins
  const calPins=p.calPins||[];
  if(calPins.length){
    html+=`<div class="cal-section-title">üìè Kalibraƒçn√≠ body (${calPins.length})</div>`;
    html+=calPins.map((pin,i)=>`
      <div class="cal-pin-row ${editCalPinId==pin.id?'sel':''}" onclick="editCalPin('${pin.id}')">
        <div class="cal-num">K${i+1}</div>
        <div class="pin-text">${pin.dist} mm</div>
        <button class="pin-del" onclick="delCalPin(event,'${pin.id}')">‚úï</button>
      </div>
    `).join('');
  }

  if(!html){html='<div style="text-align:center;color:var(--txt2);font-size:13px;padding:20px 0">≈Ω√°dn√© body ‚Äì klepnƒõte na fotku</div>';}
  list.innerHTML=html;
}

function editPin(pinId){
  const p=getP(); const pin=p.pins.find(x=>x.id==pinId);
  editPinId=pinId; pendingXY=null;
  const i=p.pins.indexOf(pin)+1;
  document.getElementById('sheetTitle').textContent=`Bod ${i} ‚Äì upravit`;
  document.getElementById('noteTA').value=pin.text||'';
  document.getElementById('noteSheet').classList.add('open');
}
async function savePin(){
  const text=document.getElementById('noteTA').value.trim();
  const p=getP();
  if(editPinId){const pin=p.pins.find(x=>x.id==editPinId);if(pin)pin.text=text;}
  else if(pendingXY){p.pins.push({id:Date.now()+Math.random(),x:pendingXY.x,y:pendingXY.y,text});}
  await dbPut('photos',p);
  closeSheet('noteSheet');
  // blur to dismiss keyboard
  document.activeElement&&document.activeElement.blur();
  // fully re-open detail after keyboard is gone
  waitForViewportStable(()=>{
    openDetail(curId,false);
  });
}

// Wait until iOS viewport stops resizing (keyboard fully dismissed)
function waitForViewportStable(cb){
  let last=window.innerHeight, checks=0, stable=0;
  const iv=setInterval(()=>{
    const h=window.innerHeight;
    if(h===last){stable++;}else{stable=0;last=h;}
    checks++;
    if(stable>=3||checks>=25){ clearInterval(iv); setTimeout(cb,100); }
  },100);
}
async function delPin(e,pinId){
  e.stopPropagation();
  const p=getP(); p.pins=p.pins.filter(x=>x.id!=pinId);
  await dbPut('photos',p); cDraw(); renderPinList(p);
}
function deletePhoto(){
  document.getElementById('confirmSheetTitle').textContent='Smazat fotku?';
  document.getElementById('confirmSheetMsg').textContent='Fotka a v≈°echny jej√≠ body budou trvale odstranƒõny.';
  document.getElementById('confirmSheetBtn').onclick=confirmDeletePhoto;
  document.getElementById('confirmSheet').classList.add('open');
}
async function confirmDeletePhoto(){
  document.getElementById('confirmSheet').classList.remove('open');
  await dbDel('photos',curId); photos=photos.filter(x=>x.id!=curId);
  renderGrid(); goTo('scrHome');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAN SELECT (choose which plan for this photo)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPlanSelect(){
  const list=document.getElementById('planSelectList');
  list.innerHTML=plans.map(pl=>`
    <div class="plan-select-card" onclick="selectPlanForPhoto('${pl.id}')">
      <img src="${pl.dataUrl}">
      <div class="plan-select-name">${esc(pl.name)}</div>
    </div>
  `).join('');
  goTo('scrPlanSelect');
}

function selectPlanForPhoto(planId){
  const p=getP();
  p.planId=planId;
  dbPut('photos',p);
  openPlanPickerWithPlan(planId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAN PICKER (mark position on plan) ‚Äì with canvas zoom
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tempPlanPos=null;
const pCanvas=document.getElementById('planCanvas');
const pCtx=pCanvas.getContext('2d');
let pImg=null, pScale=1, pMinScale=1, pMaxScale=20;
let pOffX=0, pOffY=0, pImgW=0, pImgH=0, pFitW=0, pFitH=0, pFitOX=0, pFitOY=0;
let pGesture='none', pPinchDist0=0, pPinchScale0=1, pPanStart=null, pPanOff0=null;
let pTapStart=0, pTapXY=null, pMoved=false;

function pDraw(){
  const dpr=window.devicePixelRatio||1;
  const cw=pCanvas.clientWidth, ch=pCanvas.clientHeight;
  if(pCanvas.width!==cw*dpr||pCanvas.height!==ch*dpr){pCanvas.width=cw*dpr;pCanvas.height=ch*dpr;}
  pCtx.setTransform(dpr,0,0,dpr,0,0);
  pCtx.clearRect(0,0,cw,ch);
  if(!pImg||!pImg.complete)return;
  const sw=pFitW*pScale, sh=pFitH*pScale;
  const dx=pFitOX-pOffX*pScale*(pFitW/pImgW);
  const dy=pFitOY-pOffY*pScale*(pFitH/pImgH);
  pCtx.drawImage(pImg,dx,dy,sw,sh);
  // draw existing position dot
  if(tempPlanPos){
    const px=dx+tempPlanPos.x/100*sw;
    const py=dy+tempPlanPos.y/100*sh;
    pCtx.beginPath();pCtx.arc(px,py,11,0,Math.PI*2);
    pCtx.fillStyle='#ff3b30';pCtx.fill();
    pCtx.strokeStyle='#fff';pCtx.lineWidth=3;pCtx.stroke();
  }
  // draw all other photo positions on this plan
  const currentPhoto=getP();
  photos.forEach((ph,i)=>{
    if(ph.id===currentPhoto.id)return;
    if(!ph.planPos||ph.planId!==currentPhoto.planId)return;
    const px=dx+ph.planPos.x/100*sw;
    const py=dy+ph.planPos.y/100*sh;
    pCtx.beginPath();pCtx.arc(px,py,8,0,Math.PI*2);
    pCtx.fillStyle='rgba(245,166,35,0.5)';pCtx.fill();
    pCtx.strokeStyle='#000';pCtx.lineWidth=1.5;pCtx.stroke();
    pCtx.fillStyle='#000';pCtx.font='bold 9px -apple-system,sans-serif';pCtx.textAlign='center';pCtx.textBaseline='middle';
    pCtx.fillText(String(i+1),px,py+0.5);
  });
  const badge=document.getElementById('planZoomBadge');
  if(pScale>1.05){badge.textContent=pScale.toFixed(1)+'√ó';badge.style.display='block';}
  else{badge.style.display='none';}
}

function pLoadImage(dataUrl){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      pImg=img;pImgW=img.naturalWidth;pImgH=img.naturalHeight;
      pResetView();res();
    };
    img.src=dataUrl;
  });
}

function pResetView(){
  pScale=1;pOffX=0;pOffY=0;
  const cw=pCanvas.clientWidth, ch=pCanvas.clientHeight;
  const fit=Math.min(cw/pImgW,ch/pImgH);
  pFitW=pImgW*fit;pFitH=pImgH*fit;
  pFitOX=(cw-pFitW)/2;pFitOY=(ch-pFitH)/2;
  pMinScale=1;pDraw();
}

function pClamp(){
  if(pScale<pMinScale)pScale=pMinScale;
  if(pScale>pMaxScale)pScale=pMaxScale;
  const maxOX=pImgW*(1-1/pScale)/2;
  const maxOY=pImgH*(1-1/pScale)/2;
  if(maxOX>0){pOffX=Math.max(-maxOX,Math.min(maxOX,pOffX));}else{pOffX=0;}
  if(maxOY>0){pOffY=Math.max(-maxOY,Math.min(maxOY,pOffY));}else{pOffY=0;}
}

function pClientToImgPct(cx,cy){
  const rect=pCanvas.getBoundingClientRect();
  const x=cx-rect.left, y=cy-rect.top;
  const sw=pFitW*pScale, sh=pFitH*pScale;
  const dx=pFitOX-pOffX*pScale*(pFitW/pImgW);
  const dy=pFitOY-pOffY*pScale*(pFitH/pImgH);
  const pctX=(x-dx)/sw*100, pctY=(y-dy)/sh*100;
  if(pctX<0||pctX>100||pctY<0||pctY>100)return null;
  return{x:pctX,y:pctY};
}

function pDist(a,b){return Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);}

pCanvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const t=e.touches;
  if(t.length===1){
    pGesture='pan';pPanStart={x:t[0].clientX,y:t[0].clientY};pPanOff0={x:pOffX,y:pOffY};
    pTapStart=Date.now();pTapXY={x:t[0].clientX,y:t[0].clientY};pMoved=false;
  } else if(t.length===2){
    pGesture='pinch';pPinchDist0=pDist(t[0],t[1]);pPinchScale0=pScale;pMoved=true;
  }
},{passive:false});

pCanvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  const t=e.touches;
  if(pGesture==='pan'&&t.length===1){
    const dx=t[0].clientX-pPanStart.x, dy=t[0].clientY-pPanStart.y;
    if(Math.abs(dx)>4||Math.abs(dy)>4)pMoved=true;
    if(pScale>1.05){
      const factor=pImgW/pFitW/pScale;
      pOffX=pPanOff0.x-dx*factor;pOffY=pPanOff0.y-dy*factor;
      pClamp();pDraw();
    }
  } else if(pGesture==='pinch'&&t.length===2){
    const d=pDist(t[0],t[1]);
    pScale=pPinchScale0*(d/pPinchDist0);
    pClamp();pDraw();
  }
},{passive:false});

pCanvas.addEventListener('touchend',e=>{
  e.preventDefault();
  if(e.touches.length===0){
    if(!pMoved&&(Date.now()-pTapStart)<350&&pTapXY){
      handlePlanCanvasTap(pTapXY.x,pTapXY.y);
    }
    pGesture='none';
  } else if(e.touches.length===1){
    pGesture='pan';pPanStart={x:e.touches[0].clientX,y:e.touches[0].clientY};pPanOff0={x:pOffX,y:pOffY};
  }
},{passive:false});

pCanvas.addEventListener('click',e=>{handlePlanCanvasTap(e.clientX,e.clientY);});
pCanvas.addEventListener('wheel',e=>{e.preventDefault();pScale*=e.deltaY>0?0.9:1.1;pClamp();pDraw();},{passive:false});

function handlePlanCanvasTap(cx,cy){
  const pct=pClientToImgPct(cx,cy);
  if(!pct)return;
  tempPlanPos={x:pct.x,y:pct.y};
  pScale=1;pOffX=0;pOffY=0;pClamp();pDraw();
  // auto-save and return
  setTimeout(async()=>{
    const p=getP();
    p.planPos=tempPlanPos;
    await dbPut('photos',p);
    renderPinList(p);renderGrid();
    goTo('scrDetail');
  },400);
}

function openPlanPicker(){
  const p=getP();
  if(!p.planId)return openPlanSelect();
  openPlanPickerWithPlan(p.planId);
}

function openPlanPickerWithPlan(planId){
  const pl=plans.find(x=>x.id==planId);
  if(!pl)return;
  const p=getP();
  tempPlanPos=p.planPos?{...p.planPos}:null;
  document.getElementById('planPickTitle').textContent=pl.name+' ‚Äì kde stoj√≠te?';
  goTo('scrPlan');
  pLoadImage(pl.dataUrl);
}

function cancelPlanPick(){goTo('scrDetail');}

async function clearAndSavePlanPos(){
  tempPlanPos=null;
  const p=getP(); p.planPos=null; p.planId=null;
  await dbPut('photos',p);
  renderPinList(p); renderGrid();
  goTo('scrDetail');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAME SHEET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openNameSheet(p){
  document.getElementById('nameInput').value=p.name||'';
  document.getElementById('nameSheet').classList.add('open');
  setTimeout(()=>document.getElementById('nameInput').focus(),250);
}
async function saveName(andNext){
  const val=document.getElementById('nameInput').value.trim();
  const p=getP(); p.name=val;
  await dbPut('photos',p);
  document.getElementById('detailTitle').textContent=val||'bez n√°zvu';
  closeSheet('nameSheet'); renderGrid();
  if(andNext) document.getElementById('fileCamera').click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PREV / NEXT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function prevPhoto(){
  const idx=photos.findIndex(x=>x.id==curId);
  if(idx>0) openDetail(photos[idx-1].id,false);
}
function nextPhoto(){
  const idx=photos.findIndex(x=>x.id==curId);
  if(idx<photos.length-1) openDetail(photos[idx+1].id,false);
}
function updateNavBtns(){
  const idx=photos.findIndex(x=>x.id==curId);
  document.getElementById('btnPrev').disabled=idx<=0;
  document.getElementById('btnNext').disabled=idx>=photos.length-1;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeSheet(id){
  document.getElementById(id).classList.remove('open');
  if(id==='noteSheet'){editPinId=null;pendingXY=null;}
  if(id==='calSheet'){editCalPinId=null;pendingXY=null;}
}
function sheetBg(e,id){if(e.target===e.currentTarget)closeSheet(id);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLEAR ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function deletePhoto_confirmAll(){
  document.getElementById('confirmSheetTitle').textContent='Smazat v≈°e?';
  document.getElementById('confirmSheetMsg').textContent='V≈°echny fotky, pl√°nky a data budou trvale odstranƒõny.';
  document.getElementById('confirmSheetBtn').onclick=clearAll;
  document.getElementById('confirmSheet').classList.add('open');
}
async function clearAll(){
  document.getElementById('confirmSheet').classList.remove('open');
  for(const p of photos) await dbDel('photos',p.id);
  for(const pl of plans) await dbDel('plans',pl.id);
  photos=[]; plans=[]; projectName=''; projectDate='';
  ['projectName','projectDate'].forEach(k=>dbDel('meta',k));
  document.getElementById('projectName').value='';
  document.getElementById('projectDate').textContent='';
  renderPlanLib(); renderGrid(); goHome();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doExport(){
  if(!photos.length){alert('≈Ω√°dn√© fotky.');return;}
  const btn=document.getElementById('exportBtn');
  btn.textContent='P≈ôipravuji‚Ä¶'; btn.disabled=true;
  try{
    const zip=new JSZip();
    const folder=zip.folder('fotky');
    const planFolder=zip.folder('planky');
    const exportData=[];

    // plans
    const planFiles={};
    for(let i=0;i<plans.length;i++){
      const pl=plans[i];
      const fname=`plan_${String(i+1).padStart(2,'0')}.jpg`;
      planFolder.file(fname,pl.dataUrl.split(',')[1],{base64:true});
      planFiles[pl.id]={file:'planky/'+fname,name:pl.name};
    }

    for(let i=0;i<photos.length;i++){
      const p=photos[i];
      const fname=`foto_${String(i+1).padStart(3,'0')}.jpg`;
      folder.file(fname,p.dataUrl.split(',')[1],{base64:true});
      const planInfo=p.planId&&planFiles[p.planId]?{file:planFiles[p.planId].file,name:planFiles[p.planId].name,pos:p.planPos}:null;
      exportData.push({idx:i+1,name:p.name,time:p.time,gps:p.gps,file:'fotky/'+fname,pins:p.pins,calPins:p.calPins||[],plan:planInfo,focal:p.focal||null});
    }

    zip.file('report.html',buildViewer(exportData,projectName,projectDate));
    const blob=await zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    const safe=(projectName||'prohlidka').replace(/[^a-z0-9√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•≈Ø√∫√Ω≈æ _-]/gi,'').replace(/\s+/g,'_');
    a.href=url; a.download=safe+'_'+new Date().toISOString().slice(0,10)+'.zip';
    a.click(); setTimeout(()=>URL.revokeObjectURL(url),5000);
  }catch(e){alert('Chyba: '+e.message);}
  btn.textContent='‚¨á Exportovat ZIP'; btn.disabled=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PC VIEWER (embedded in export ZIP)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildViewer(data,pName,pDate){
return `<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${esc(pName||'Prohl√≠dka')} ‚Äì Report v5_5</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"><` + `/script>
<style>
:root{--bg:#f5f5f7;--s1:#fff;--s2:#e8e8ed;--acc:#f5a623;--txt:#1d1d1f;--txt2:#6e6e73;--r:10px;--blue:#2196F3}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--txt);font-family:-apple-system,'Helvetica Neue',sans-serif;display:flex;flex-direction:column;height:100vh}
.header{background:var(--s1);border-bottom:1px solid var(--s2);padding:16px 20px}
.header h1{font-size:20px;font-weight:700;color:var(--acc)}
.header .meta{font-size:12px;color:var(--txt2);margin-top:4px}
.main{flex:1;display:flex;overflow:hidden}
.thumb-panel{width:180px;background:var(--s1);border-right:1px solid var(--s2);overflow-y:auto;flex-shrink:0}
.thumb-item{padding:8px;cursor:pointer;border-bottom:1px solid var(--s2);transition:background .15s}
.thumb-item:hover,.thumb-item.sel{background:#f0e6d0}
.thumb-item img{width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:6px;display:block}
.thumb-info{margin-top:5px}
.thumb-name{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.thumb-meta{font-size:10px;color:var(--txt2)}
.thumb-pins{font-size:10px;color:var(--acc);font-weight:600;margin-top:1px}
.content{flex:1;display:flex;overflow:hidden}
.img-col{flex:1;background:#222;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:crosshair}
.img-col img{max-width:100%;max-height:100%;display:block}
.pin-mark{position:absolute;width:26px;height:26px;transform:translate(-50%,-50%);cursor:pointer;z-index:5}
.pin-mark-inner{width:100%;height:100%;border-radius:50%;background:#f5a623;border:2px solid #000;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:#000;box-shadow:0 1px 6px rgba(0,0,0,.5)}
.pin-mark.cal .pin-mark-inner{background:var(--blue);border-color:#fff;color:#fff}
.pin-mark.hl .pin-mark-inner{background:#fff;border-color:#f5a623;color:#f5a623}
.pin-mark.mpt{z-index:10}
.pin-mark.mpt .pin-mark-inner{background:#ff3b30;border-color:#fff;color:#fff;width:20px;height:20px}
.measure-line{position:absolute;pointer-events:none;z-index:8}
.measure-result{position:absolute;z-index:11;background:rgba(0,0,0,.85);color:#fff;padding:4px 10px;border-radius:6px;font-size:13px;font-weight:700;transform:translate(-50%,-50%);pointer-events:none;white-space:nowrap}
.notes-col{width:320px;background:var(--s1);border-left:1px solid var(--s2);display:flex;flex-direction:column;overflow:hidden}
.notes-header{padding:14px;border-bottom:1px solid var(--s2)}
.notes-title{font-size:16px;font-weight:700}
.notes-meta-row{font-size:11px;color:var(--txt2);margin-top:4px}
.notes-meta-row a{color:var(--acc)}
.notes-list{flex:1;overflow-y:auto;padding:10px}
.note-row{display:flex;gap:8px;padding:8px;border-radius:8px;cursor:pointer;transition:background .15s;align-items:flex-start}
.note-row:hover,.note-row.hl{background:#f0e6d0}
.note-num{width:22px;height:22px;border-radius:50%;background:var(--acc);color:#000;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.note-num.cal{background:var(--blue);color:#fff}
.note-text{font-size:13px;line-height:1.45;flex:1}
.plan-section{border-top:1px solid var(--s2);padding:10px}
.plan-section img{width:100%;border-radius:6px;display:block}
.plan-section-wrap{position:relative;display:inline-block;width:100%}
.plan-dot-view{position:absolute;width:14px;height:14px;background:#ff3b30;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 1px 4px rgba(0,0,0,.5)}
.nav-bar{padding:8px 14px;border-top:1px solid var(--s2);display:flex;gap:8px;align-items:center}
.nav-bar button{padding:6px 14px;border:1px solid var(--s2);border-radius:6px;background:var(--s1);cursor:pointer;font-size:13px;font-weight:600}
.nav-bar button:hover{background:#f0e6d0}
.nav-bar span{flex:1;text-align:center;font-size:12px;color:var(--txt2)}
#mapContainer{height:300px;border-top:1px solid var(--s2);display:none}
.map-toggle{padding:8px 14px;border-top:1px solid var(--s2);text-align:center}
.map-toggle a{color:var(--acc);cursor:pointer;font-size:13px;font-weight:600;text-decoration:none}
.plan-label{font-size:11px;color:var(--txt2);margin-bottom:4px;font-weight:600}
/* CALIBRATION */
.cal-panel{border-top:1px solid var(--s2);padding:10px;background:#f8f9ff}
.cal-title{font-size:11px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px}
.cal-type-row{display:flex;gap:6px;margin-bottom:8px}
.cal-type-btn{padding:5px 10px;border:1px solid var(--s2);border-radius:6px;font-size:11px;cursor:pointer;background:var(--s1);font-weight:600;font-family:inherit}
.cal-type-btn.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.cal-info{font-size:11px;color:var(--txt2);line-height:1.5;margin-bottom:6px}
.cal-input-row{display:flex;gap:6px;align-items:center;margin-bottom:6px;font-size:12px}
.cal-input-row input{width:80px;padding:4px 8px;border:1px solid var(--s2);border-radius:5px;font-size:12px;font-family:inherit}
.cal-input-row select{padding:4px 6px;border:1px solid var(--s2);border-radius:5px;font-size:12px;font-family:inherit}
.cal-status{font-size:12px;padding:6px 8px;border-radius:6px;margin-top:6px}
.cal-ok{background:#e8f5e9;color:#2e7d32}
.cal-warn{background:#fff3e0;color:#e65100}
.measure-btn{padding:6px 14px;border:1px solid var(--blue);border-radius:6px;background:var(--s1);cursor:pointer;font-size:12px;font-weight:600;color:var(--blue);font-family:inherit;margin-top:6px}
.measure-btn.active{background:var(--blue);color:#fff}
.measure-btn:hover{opacity:.8}
.offset-row{display:flex;gap:6px;align-items:center;margin-top:6px;font-size:12px}
.offset-row input{width:70px;padding:4px 8px;border:1px solid var(--s2);border-radius:5px;font-size:12px;font-family:inherit}
</style>
</head>
<body>
<div class="header">
  <h1>${esc(pName||'Prohl√≠dka')}</h1>
  <div class="meta">${esc(pDate)} ¬∑ ${data.length} fotografi√≠ ¬∑ ${data.reduce((s,p)=>s+p.pins.length,0)} pozn√°mek ¬∑ Inspektor v5_6</div>
</div>
<div class="main">
  <div class="thumb-panel" id="thumbPanel"></div>
  <div class="content">
    <div class="img-col" id="imgContainer"><img id="mainImg" src=""></div>
    <div class="notes-col">
      <div class="notes-header">
        <div class="notes-title" id="notesTitle">‚Äî</div>
        <div id="notesMeta"></div>
      </div>
      <div class="notes-list" id="notesList"></div>
      <div id="calPanel" class="cal-panel" style="display:none">
        <div class="cal-title">üìè Kalibrace a mƒõ≈ôen√≠</div>
        <div class="cal-type-row">
          <button class="cal-type-btn active" onclick="setCalType(1)">1 bod (kolmo)</button>
          <button class="cal-type-btn" onclick="setCalType(2)">2 body (svisl√°)</button>
          <button class="cal-type-btn" onclick="setCalType(3)">3+ body (obecn√°)</button>
        </div>
        <div id="calTypeInfo" class="cal-info"></div>
        <div class="cal-input-row">
          <span>Ohniskov√° (35mm ekv.):</span>
          <input type="number" id="focalInput" value="26" style="width:60px" onchange="updateCalibration()"> mm
          <span id="focalNote" style="font-size:10px;color:var(--txt2)"></span>
        </div>
        <div id="calInputs"></div>
        <div id="calStatus"></div>
        <div class="offset-row" id="offsetRow" style="display:none">
          <span>Odsazen√≠ roviny:</span>
          <input type="number" id="offsetInput" value="0" onchange="updateCalibration()"> mm
        </div>
        <button class="measure-btn" id="measureBtn" onclick="toggleMeasure()" style="display:none">üìè Mƒõ≈ôit vzd√°lenost</button>
      </div>
      <div id="planSection" style="display:none">
        <div class="plan-section">
          <div class="plan-label" id="planLabel"></div>
          <div class="plan-section-wrap" id="planWrap">
            <img id="planImg" src="">
            <div class="plan-dot-view" id="planDot" style="display:none"></div>
          </div>
        </div>
      </div>
      <div class="nav-bar">
        <button onclick="prev()">‚Üê P≈ôedchoz√≠</button>
        <span id="navInfo">1 / ${data.length}</span>
        <button onclick="next()">Dal≈°√≠ ‚Üí</button>
      </div>
    </div>
  </div>
</div>
<div class="map-toggle"><a onclick="toggleMap()">üó∫ Zobrazit/skr√Ωt mapu</a></div>
<div id="mapContainer"></div>
<script>
const DATA=${JSON.stringify(data)};
let cur=0, map=null, mapOn=false;
let calType=1, calibrated=false, measuring=false;
let measurePts=[], planeNormal=null, planeD=0, focalPx=0;
let imgNatW=0, imgNatH=0;

const DEFAULT_FOCAL35=26; // iPhone main camera

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

document.getElementById('thumbPanel').innerHTML=DATA.map((p,i)=>\`
  <div class="thumb-item" id="th-\${i}" onclick="show(\${i})">
    <img src="\${p.file}" loading="lazy">
    <div class="thumb-info">
      <div class="thumb-name">\${esc(p.name||'Foto '+p.idx)}</div>
      <div class="thumb-meta">\${p.time}</div>
      <div class="thumb-pins">\${p.pins.length} pozn.\${p.calPins&&p.calPins.length?' ¬∑ '+p.calPins.length+'üìè':''}\${p.plan?' ¬∑ üìã':''}</div>
    </div>
  </div>
\`).join('');

function show(i){
  cur=i; const p=DATA[i];
  measuring=false;measurePts=[];calibrated=false;
  document.querySelectorAll('.mpt,.measure-line,.measure-result').forEach(e=>e.remove());
  document.querySelectorAll('.thumb-item').forEach(e=>e.classList.remove('sel'));
  const th=document.getElementById('th-'+i);if(th){th.classList.add('sel');th.scrollIntoView({block:'nearest'});}

  const img=document.getElementById('mainImg');
  img.src=p.file;
  document.getElementById('notesTitle').textContent=p.name||('Foto '+p.idx);
  document.getElementById('navInfo').textContent=(i+1)+' / '+DATA.length;

  let meta=\`<div class="notes-meta-row">üïê \${p.time}</div>\`;
  if(p.gps) meta+=\`<div class="notes-meta-row"><a href="https://www.google.com/maps?q=\${p.gps.lat},\${p.gps.lng}" target="_blank">üìç \${p.gps.lat}, \${p.gps.lng} ¬±\${p.gps.acc}m</a></div>\`;
  if(p.focal){
    const f35=p.focal.focal35, fr=p.focal.focalRaw;
    let ft=f35?f35+'mm(35)':'';if(fr)ft+=(ft?' / ':'')+fr+'mm';
    if(ft)meta+=\`<div class="notes-meta-row">üî≠ \${ft}</div>\`;
    if(f35&&f35!==26&&f35!==28)meta+=\`<div class="notes-meta-row" style="color:#e65100">‚ö† nestandardn√≠ objektiv ‚Äì mƒõ≈ôen√≠ m≈Ø≈æe b√Ωt nep≈ôesn√©</div>\`;
  }
  document.getElementById('notesMeta').innerHTML=meta;

  // notes + cal pins list
  let listHtml='';
  if(p.pins.length){
    listHtml+=p.pins.map((pin,j)=>\`<div class="note-row" id="nr-\${j}" onclick="hlPin(\${j})"><div class="note-num">\${j+1}</div><div class="note-text">\${esc(pin.text||'‚Äî')}</div></div>\`).join('');
  }
  if(p.calPins&&p.calPins.length){
    listHtml+=\`<div style="font-size:11px;font-weight:700;color:#2196F3;text-transform:uppercase;padding:8px 0 4px">üìè Kalibraƒçn√≠ body</div>\`;
    listHtml+=p.calPins.map((pin,j)=>\`<div class="note-row" onclick="hlCalPin(\${j})"><div class="note-num cal">K\${j+1}</div><div class="note-text">\${pin.dist} mm</div></div>\`).join('');
  }
  if(!listHtml)listHtml='<div style="padding:18px;color:#aaa;font-size:13px;text-align:center">Bez pozn√°mek</div>';
  document.getElementById('notesList').innerHTML=listHtml;

  // calibration panel
  const cp=document.getElementById('calPanel');
  if(p.calPins&&p.calPins.length>0){
    cp.style.display='block';
    // set focal from EXIF
    const fi=document.getElementById('focalInput');
    const fn=document.getElementById('focalNote');
    if(p.focal&&p.focal.focal35){
      fi.value=p.focal.focal35;
      fn.textContent='(z EXIF)';fn.style.color='#2e7d32';
    } else {
      fi.value=DEFAULT_FOCAL35;
      fn.textContent='(v√Ωchoz√≠ ‚Äì EXIF chyb√≠!)';fn.style.color='#e65100';
    }
    setCalType(p.calPins.length>=3?3:p.calPins.length);
  } else {
    cp.style.display='none';
  }

  // plan
  const ps=document.getElementById('planSection');
  if(p.plan&&p.plan.pos){
    ps.style.display='block';
    document.getElementById('planLabel').textContent=p.plan.name||'Pl√°nek';
    document.getElementById('planImg').src=p.plan.file;
    const dot=document.getElementById('planDot');
    dot.style.display='block';dot.style.left=p.plan.pos.x+'%';dot.style.top=p.plan.pos.y+'%';
  } else {ps.style.display='none';}

  document.querySelectorAll('.pin-mark').forEach(e=>e.remove());
  const onLoad=()=>{imgNatW=img.naturalWidth;imgNatH=img.naturalHeight;positionPins(p);};
  img.onload=onLoad;
  if(img.complete)onLoad();
  if(map)map.invalidateSize();
}

function positionPins(p){
  document.querySelectorAll('.pin-mark:not(.mpt)').forEach(e=>e.remove());
  const img=document.getElementById('mainImg');
  const con=document.getElementById('imgContainer');
  const ir=img.getBoundingClientRect();const cr=con.getBoundingClientRect();
  // doc pins
  p.pins.forEach((pin,i)=>{
    const el=document.createElement('div');
    el.className='pin-mark';el.dataset.j=i;
    el.innerHTML=\`<div class="pin-mark-inner">\${i+1}</div>\`;
    el.style.left=(ir.left-cr.left+pin.x/100*ir.width)+'px';
    el.style.top=(ir.top-cr.top+pin.y/100*ir.height)+'px';
    el.addEventListener('click',()=>hlPin(i));
    con.appendChild(el);
  });
  // cal pins
  if(p.calPins){
    p.calPins.forEach((pin,i)=>{
      const el=document.createElement('div');
      el.className='pin-mark cal';el.dataset.k=i;
      el.innerHTML=\`<div class="pin-mark-inner">K\${i+1}</div>\`;
      el.style.left=(ir.left-cr.left+pin.x/100*ir.width)+'px';
      el.style.top=(ir.top-cr.top+pin.y/100*ir.height)+'px';
      el.addEventListener('click',()=>hlCalPin(i));
      con.appendChild(el);
    });
  }
}

function hlPin(j){
  document.querySelectorAll('.pin-mark').forEach(e=>e.classList.remove('hl'));
  document.querySelectorAll('.note-row').forEach(e=>e.classList.remove('hl'));
  const pm=document.querySelector(\`.pin-mark[data-j="\${j}"]\`);if(pm)pm.classList.add('hl');
  const nr=document.getElementById('nr-'+j);if(nr){nr.classList.add('hl');nr.scrollIntoView({block:'nearest'});}
}
function hlCalPin(j){
  document.querySelectorAll('.pin-mark').forEach(e=>e.classList.remove('hl'));
  const pm=document.querySelector(\`.pin-mark.cal[data-k="\${j}"]\`);if(pm)pm.classList.add('hl');
}

// ‚îÄ‚îÄ CALIBRATION ‚îÄ‚îÄ
function setCalType(t){
  calType=t;
  document.querySelectorAll('.cal-type-btn').forEach((b,i)=>b.classList.toggle('active',i+1===t));
  const info=document.getElementById('calTypeInfo');
  const inputs=document.getElementById('calInputs');
  const p=DATA[cur];
  const nCal=(p.calPins||[]).length;
  if(t===1){
    info.innerHTML='Rovina kolm√° na osu objektivu. Bod K1 v ose objektivu, vzd√°lenost = kolm√° vzd√°lenost.';
    if(nCal<1){inputs.innerHTML='<div class="cal-status cal-warn">Pot≈ôeba alespo≈à 1 kalibraƒçn√≠ bod</div>';return;}
  } else if(t===2){
    info.innerHTML='Svisl√° rovina definovan√° dvƒõma body. Body mohou b√Ωt vedle sebe i nad sebou.';
    if(nCal<2){inputs.innerHTML='<div class="cal-status cal-warn">Pot≈ôeba alespo≈à 2 kalibraƒçn√≠ body</div>';return;}
  } else {
    info.innerHTML='Obecn√° rovina definovan√° t≈ôemi a v√≠ce body v prostoru.';
    if(nCal<3){inputs.innerHTML='<div class="cal-status cal-warn">Pot≈ôeba alespo≈à 3 kalibraƒçn√≠ body</div>';return;}
  }
  inputs.innerHTML='';
  updateCalibration();
}

function getFocalPx(){
  const f35=parseFloat(document.getElementById('focalInput').value)||DEFAULT_FOCAL35;
  // focal in pixels: f_px = (f_35mm / 36) * max(imgW, imgH) for landscape, use wider dimension
  const maxDim=Math.max(imgNatW,imgNatH);
  return (f35/36)*maxDim;
}

function pixToRay(px,py){
  // convert image pixel coords to 3D ray from camera (camera at origin, looking along Z)
  const fpx=getFocalPx();
  const cx=imgNatW/2, cy=imgNatH/2;
  return {x:(px-cx)/fpx, y:(py-cy)/fpx, z:1};
}

function updateCalibration(){
  const p=DATA[cur];
  const cals=p.calPins||[];
  const status=document.getElementById('calStatus');
  const offsetRow=document.getElementById('offsetRow');
  const mBtn=document.getElementById('measureBtn');
  calibrated=false;
  focalPx=getFocalPx();

  if(calType===1&&cals.length>=1){
    // perpendicular plane at distance d from camera
    const d=cals[0].dist;
    planeNormal={x:0,y:0,z:1};
    planeD=d;
    calibrated=true;
    status.innerHTML='<div class="cal-status cal-ok">‚úì Kalibrov√°no ‚Äì kolm√° rovina ve vzd√°lenosti '+d+' mm</div>';
  } else if(calType===2&&cals.length>=2){
    // vertical plane through two points
    const r0=pixToRay(cals[0].x/100*imgNatW,cals[0].y/100*imgNatH);
    const r1=pixToRay(cals[1].x/100*imgNatW,cals[1].y/100*imgNatH);
    const d0=cals[0].dist, d1=cals[1].dist;
    // 3D points
    const p0={x:r0.x*d0,y:r0.y*d0,z:r0.z*d0};
    const p1={x:r1.x*d1,y:r1.y*d1,z:r1.z*d1};
    // vertical plane: normal is horizontal, perpendicular to line p0-p1 projected to XZ
    const dx=p1.x-p0.x, dz=p1.z-p0.z;
    const len=Math.sqrt(dx*dx+dz*dz);
    if(len<0.001){status.innerHTML='<div class="cal-status cal-warn">Body jsou p≈ô√≠li≈° bl√≠zko</div>';return;}
    planeNormal={x:-dz/len,y:0,z:dx/len};
    planeD=planeNormal.x*p0.x+planeNormal.z*p0.z;
    calibrated=true;
    status.innerHTML='<div class="cal-status cal-ok">‚úì Kalibrov√°no ‚Äì svisl√° rovina ze 2 bod≈Ø</div>';
  } else if(calType===3&&cals.length>=3){
    // general plane from 3 points
    const rays=cals.slice(0,3).map(c=>pixToRay(c.x/100*imgNatW,c.y/100*imgNatH));
    const pts=cals.slice(0,3).map((c,i)=>({x:rays[i].x*c.dist,y:rays[i].y*c.dist,z:rays[i].z*c.dist}));
    const v1={x:pts[1].x-pts[0].x,y:pts[1].y-pts[0].y,z:pts[1].z-pts[0].z};
    const v2={x:pts[2].x-pts[0].x,y:pts[2].y-pts[0].y,z:pts[2].z-pts[0].z};
    const n={x:v1.y*v2.z-v1.z*v2.y, y:v1.z*v2.x-v1.x*v2.z, z:v1.x*v2.y-v1.y*v2.x};
    const nlen=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);
    if(nlen<0.001){status.innerHTML='<div class="cal-status cal-warn">Body jsou koline√°rn√≠</div>';return;}
    planeNormal={x:n.x/nlen,y:n.y/nlen,z:n.z/nlen};
    planeD=planeNormal.x*pts[0].x+planeNormal.y*pts[0].y+planeNormal.z*pts[0].z;
    calibrated=true;
    status.innerHTML='<div class="cal-status cal-ok">‚úì Kalibrov√°no ‚Äì obecn√° rovina ze 3 bod≈Ø</div>';
  } else {
    status.innerHTML='<div class="cal-status cal-warn">Nedostatek kalibraƒçn√≠ch bod≈Ø</div>';
    mBtn.style.display='none';
    offsetRow.style.display='none';
    return;
  }

  // apply offset
  const off=parseFloat(document.getElementById('offsetInput').value)||0;
  if(off!==0){
    planeD+=off;
    status.innerHTML+='<div style="font-size:11px;color:var(--txt2);margin-top:4px">+ odsazen√≠ '+off+' mm</div>';
  }

  // diagnostic info
  const fpx=getFocalPx();
  const f35=parseFloat(document.getElementById('focalInput').value)||DEFAULT_FOCAL35;
  const fovH=2*Math.atan(Math.max(imgNatW,imgNatH)/(2*fpx))*180/Math.PI;
  status.innerHTML+='<div style="font-size:10px;color:var(--txt2);margin-top:4px">Obraz: '+imgNatW+'√ó'+imgNatH+'px ¬∑ f='+f35+'mm(35) ¬∑ f_px='+Math.round(fpx)+' ¬∑ FOV='+fovH.toFixed(1)+'¬∞</div>';

  mBtn.style.display='inline-block';
  offsetRow.style.display='flex';
}

// ‚îÄ‚îÄ MEASUREMENT ‚îÄ‚îÄ
function toggleMeasure(){
  measuring=!measuring;
  const btn=document.getElementById('measureBtn');
  btn.classList.toggle('active',measuring);
  btn.textContent=measuring?'üìè Kliknƒõte na 2 body ve fotce':'üìè Mƒõ≈ôit vzd√°lenost';
  if(!measuring){
    measurePts=[];
    document.querySelectorAll('.mpt,.measure-line,.measure-result').forEach(e=>e.remove());
  }
  document.getElementById('imgContainer').style.cursor=measuring?'crosshair':'default';
}

document.getElementById('imgContainer').addEventListener('click',function(ev){
  if(!measuring||!calibrated)return;
  const img=document.getElementById('mainImg');
  const ir=img.getBoundingClientRect();
  const con=this;const cr=con.getBoundingClientRect();
  const x=ev.clientX,y=ev.clientY;
  if(x<ir.left||x>ir.right||y<ir.top||y>ir.bottom)return;
  const pctX=(x-ir.left)/ir.width*100;
  const pctY=(y-ir.top)/ir.height*100;
  measurePts.push({pctX,pctY,screenX:x-cr.left,screenY:y-cr.top});

  // draw point
  const el=document.createElement('div');
  el.className='pin-mark mpt';
  el.innerHTML='<div class="pin-mark-inner">'+measurePts.length+'</div>';
  el.style.left=(x-cr.left)+'px';el.style.top=(y-cr.top)+'px';
  con.appendChild(el);

  if(measurePts.length===2){
    const a=measurePts[0],b=measurePts[1];
    // convert to image pixels
    const ax=a.pctX/100*imgNatW, ay=a.pctY/100*imgNatH;
    const bx=b.pctX/100*imgNatW, by=b.pctY/100*imgNatH;
    // rays
    const ra=pixToRay(ax,ay), rb=pixToRay(bx,by);
    // intersect rays with plane
    const dota=planeNormal.x*ra.x+planeNormal.y*ra.y+planeNormal.z*ra.z;
    const dotb=planeNormal.x*rb.x+planeNormal.y*rb.y+planeNormal.z*rb.z;
    if(Math.abs(dota)<1e-9||Math.abs(dotb)<1e-9){measurePts=[];return;}
    const ta=planeD/dota, tb=planeD/dotb;
    const pa={x:ra.x*ta,y:ra.y*ta,z:ra.z*ta};
    const pb={x:rb.x*tb,y:rb.y*tb,z:rb.z*tb};
    const dist=Math.sqrt((pb.x-pa.x)**2+(pb.y-pa.y)**2+(pb.z-pa.z)**2);

    // draw line
    const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('class','measure-line');
    svg.style.cssText='position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:8';
    svg.innerHTML=\`<line x1="\${a.screenX}" y1="\${a.screenY}" x2="\${b.screenX}" y2="\${b.screenY}" stroke="#ff3b30" stroke-width="2" stroke-dasharray="6,4"/>\`;
    con.appendChild(svg);

    // draw result label
    const lbl=document.createElement('div');
    lbl.className='measure-result';
    lbl.textContent=Math.round(dist)+' mm';
    lbl.style.left=((a.screenX+b.screenX)/2)+'px';
    lbl.style.top=((a.screenY+b.screenY)/2-16)+'px';
    con.appendChild(lbl);

    // reset for next measurement
    setTimeout(()=>{measurePts=[];},100);
  }
});

function prev(){if(cur>0)show(cur-1);}
function next(){if(cur<DATA.length-1)show(cur+1);}
document.addEventListener('keydown',e=>{if(e.key==='ArrowLeft')prev();if(e.key==='ArrowRight')next();});
window.addEventListener('resize',()=>{if(DATA[cur])positionPins(DATA[cur]);});

function toggleMap(){
  mapOn=!mapOn;
  const mc=document.getElementById('mapContainer');
  mc.style.display=mapOn?'block':'none';
  if(mapOn&&!map)initMap();else if(map)map.invalidateSize();
}
function initMap(){
  const pts=DATA.filter(p=>p.gps);
  if(!pts.length){document.getElementById('mapContainer').innerHTML='<div style="padding:16px;color:#aaa;font-size:12px;text-align:center">≈Ω√°dn√© GPS sou≈ôadnice</div>';return;}
  map=L.map('mapContainer');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM',maxZoom:19}).addTo(map);
  const icon=L.divIcon({className:'',html:'<div style="width:18px;height:18px;background:#f5a623;border:2px solid #000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;color:#000;box-shadow:0 1px 5px rgba(0,0,0,.5)"></div>',iconSize:[18,18],iconAnchor:[9,9]});
  const bounds=[];
  pts.forEach(p=>{
    const lat=parseFloat(p.gps.lat),lng=parseFloat(p.gps.lng);
    bounds.push([lat,lng]);
    const m=L.marker([lat,lng],{icon}).addTo(map);
    m.bindPopup(\`<b>\${esc(p.name||'Foto '+p.idx)}</b><br>\${p.time}<br>\${p.pins.length} pozn√°mek\`);
    m.on('click',()=>show(DATA.indexOf(p)));
  });
  map.fitBounds(bounds,{padding:[16,16]});
}

if(DATA.length)show(0);
<` + `/script>
</body>
</html>`;
}
</script>
</body>
</html>
